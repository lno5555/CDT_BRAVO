# Author: Lukasz Ozimek
# Email: lno5555@rit.edu


#Windows
---
  - name: Configure DNS for windows
    hosts: windows
    vars:
      new_user: DNSadmin
      dns_servers:
        - 8.8.8.8
        - 129.21.1.82
      dns_suffix: lab.local

    tasks:
      - name: Configure DNS Servers on primary adapter
        win_dns_client:
          adapter_names: "*"
          dns_servers: "{{ dns_servers }}"

      - name: Set DNS Suffix search list
        win_regedit:
          path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
          name: SearchList
          data: "{{ dns_suffix }}"
          type: string


      - name: Enable Windows Firewall
        win_firewall:
          state: enabled
          profiles:
            - Domain
            - Private
            - Public


      - name: Allow DNS through Firewall
        win_firewall_rule:
          name: Allow DNS
          localport: 53
          protocol: UDP
          direction: in
          action: allow


      - name: Create a local user
        win_user:
          name: "{{ new_user }}"
          password: "Password123!"
          state: present
          groups:
            - Users
            - Domain Users

      - name: Enable DNS Client logging
        win_shell: |
          wevtutil set-log Microsoft-Windows-DNS-Client/Operational /enabled:true
        changed_when: true


      - name: Verify DNS is up
        win_shell: Get-DnsClientServerAddress
        register: dns_check
        changed_when: false

      - debug:
          var: dns_check.stdout
